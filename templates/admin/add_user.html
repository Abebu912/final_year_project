{% extends 'base.html' %}
{% load static %}

{% block title %}Add User - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2"></i>Add New User
                    </h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>Please correct the following errors:</strong>
                                <ul class="mb-0 mt-1">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.username.id_for_label }}" class="form-label">Username *</label>
                                    {{ form.username }}
                                    <div class="form-text">Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                                    {{ form.email }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                                    {{ form.first_name }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                                    {{ form.last_name }}
                                </div>
                            </div>
                        </div>

                        <!-- Role Selection -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.role.id_for_label }}" class="form-label">Role *</label>
                                    {{ form.role }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.phone.id_for_label }}" class="form-label">Phone</label>
                                    {{ form.phone }}
                                </div>
                            </div>
                        </div>

                        <!-- Auto-approval for admin -->
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3 form-check">
                                    {{ form.is_approved }}
                                    <label class="form-check-label" for="{{ form.is_approved.id_for_label }}">
                                        Auto-approve this user (user can login immediately)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Role-specific fields -->
                        <!-- Student Fields -->
                        <div id="student-fields" class="role-fields mb-3" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-graduation-cap me-2"></i>Student Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.grade_level.id_for_label }}" class="form-label">Grade Level *</label>
                                                {{ form.grade_level }}
                                                {% if form.grade_level.help_text %}
                                                    <div class="form-text">{{ form.grade_level.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.academic_year.id_for_label }}" class="form-label">Academic Year *</label>
                                                {{ form.academic_year }}
                                                {% if form.academic_year.help_text %}
                                                    <div class="form-text">{{ form.academic_year.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.current_semester.id_for_label }}" class="form-label">Current Semester *</label>
                                                {{ form.current_semester }}
                                                {% if form.current_semester.help_text %}
                                                    <div class="form-text">{{ form.current_semester.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Teacher Fields -->
                        <div id="teacher-fields" class="role-fields mb-3" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-chalkboard-teacher me-2"></i>Teacher Information
                                    </h6>
                                    <div class="mb-3">
                                        <label for="{{ form.department.id_for_label }}" class="form-label">Department *</label>
                                        {{ form.department }}
                                        {% if form.department.help_text %}
                                            <div class="form-text">{{ form.department.help_text }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.qualification.id_for_label }}" class="form-label">Qualification *</label>
                                        {{ form.qualification }}
                                        {% if form.qualification.help_text %}
                                            <div class="form-text">{{ form.qualification.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parent Fields -->
                        <div id="parent-fields" class="role-fields mb-3" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-users me-2"></i>Parent Information
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.occupation.id_for_label }}" class="form-label">Occupation *</label>
                                                {{ form.occupation }}
                                                {% if form.occupation.help_text %}
                                                    <div class="form-text">{{ form.occupation.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.relationship.id_for_label }}" class="form-label">Relationship *</label>
                                                {{ form.relationship }}
                                                {% if form.relationship.help_text %}
                                                    <div class="form-text">{{ form.relationship.help_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.student_id_link.id_for_label }}" class="form-label">Link to Student (Optional)</label>
                                        {{ form.student_id_link }}
                                        {% if form.student_id_link.help_text %}
                                            <div class="form-text">{{ form.student_id_link.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registrar Fields -->
                        <div id="registrar-fields" class="role-fields mb-3" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-file-contract me-2"></i>Registrar Information
                                    </h6>
                                    <div class="mb-3">
                                        <label for="{{ form.office.id_for_label }}" class="form-label">Office *</label>
                                        {{ form.office }}
                                        {% if form.office.help_text %}
                                            <div class="form-text">{{ form.office.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Finance Fields -->
                        <div id="finance-fields" class="role-fields mb-3" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-money-bill-wave me-2"></i>Finance Information
                                    </h6>
                                    <div class="mb-3">
                                        <label for="{{ form.finance_id.id_for_label }}" class="form-label">Finance ID *</label>
                                        {{ form.finance_id }}
                                        {% if form.finance_id.help_text %}
                                            <div class="form-text">{{ form.finance_id.help_text }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Passwords -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.password1.id_for_label }}" class="form-label">Password *</label>
                                    {{ form.password1 }}
                                    {% if form.password1.help_text %}
                                        <div class="form-text">{{ form.password1.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.password2.id_for_label }}" class="form-label">Password Confirmation *</label>
                                    {{ form.password2 }}
                                    {% if form.password2.help_text %}
                                        <div class="form-text">{{ form.password2.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'manage_users' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to User Management
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Create User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.querySelector('#{{ form.role.id_for_label }}');
    const roleFields = document.querySelectorAll('.role-fields');
    
    function toggleRoleFields() {
        // Hide all role fields
        roleFields.forEach(field => {
            field.style.display = 'none';
        });
        
        // Show relevant fields based on selection
        const selectedRole = roleSelect.value;
        if (selectedRole === 'student') {
            document.getElementById('student-fields').style.display = 'block';
        } else if (selectedRole === 'teacher') {
            document.getElementById('teacher-fields').style.display = 'block';
        } else if (selectedRole === 'parent') {
            document.getElementById('parent-fields').style.display = 'block';
        } else if (selectedRole === 'registrar') {
            document.getElementById('registrar-fields').style.display = 'block';
        } else if (selectedRole === 'finance') {
            document.getElementById('finance-fields').style.display = 'block';
        }
    }
    
    // Initial toggle
    toggleRoleFields();
    
    // Add event listener for changes
    if (roleSelect) {
        roleSelect.addEventListener('change', toggleRoleFields);
    }
});
</script>

<style>
.form-control, .form-select {
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid #ced4da;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.role-fields {
    transition: all 0.3s ease;
}

.card {
    border-radius: 0.5rem;
}

.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
}

.form-check-input {
    margin-right: 0.5rem;
}

.form-check-label {
    font-weight: 500;
}
</style>
{% endblock %}