{% extends 'base.html' %}
{% block title %}Enter Grades{% endblock %}
{% block content %}
<div class="container py-4">
  <h2>Enter Scores</h2>
  <form method="get" class="mb-3">
    <label for="subject">Select subject:</label>
    <select id="subject" name="subject_id" onchange="this.form.submit()">
      <option value="">--Select--</option>
      {% for c in teacher_subjects %}
      <option value="{{ c.id }}" {% if selected_subject and selected_subject.id == c.id %}selected{% endif %}>{{ c.code }} - {{ c.name }}</option>
      {% endfor %}
    </select>
  </form>

  {% if selected_subject %}
  <h4>Entering scores for {{ selected_subject.name }}</h4>
  <form method="post">
    {% csrf_token %}
    <table class="table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Student</th>
          <th>Quiz (5)</th>
          <th>Mid (25)</th>
          <th>Assignment (20)</th>
          <th>Final (50)</th>
          <th>Total (100)</th>
          <th>Average</th>
          <th>Edit</th>
          <th>Save</th>
        </tr>
      </thead>
      <tbody>
        {% for en in enrollments %}
        <tr id="row-{{ en.student.id }}">
          <td>{% if en.rank %}{{ en.rank }}{% else %}-{% endif %}</td>
          <td>{{ en.student.get_full_name }}</td>
          <td>
            <input type="number" min="0" max="5" class="form-control comp-input" id="quiz-{{ en.student.id }}" name="quiz_{{ en.student.id }}" value="{{ en.quiz_score|default_if_none:'' }}">
          </td>
          <td>
            <input type="number" min="0" max="25" class="form-control comp-input" id="mid-{{ en.student.id }}" name="mid_{{ en.student.id }}" value="{{ en.mid_score|default_if_none:'' }}">
          </td>
          <td>
            <input type="number" min="0" max="20" class="form-control comp-input" id="assign-{{ en.student.id }}" name="assign_{{ en.student.id }}" value="{{ en.assignment_score|default_if_none:'' }}">
          </td>
          <td>
            <input type="number" min="0" max="50" class="form-control comp-input" id="final-{{ en.student.id }}" name="final_{{ en.student.id }}" value="{{ en.final_score|default_if_none:'' }}">
          </td>
          <td>
            <input type="number" min="0" max="100" class="form-control" id="total-{{ en.student.id }}" name="grade_{{ en.student.id }}" value="{{ en.current_score|default_if_none:'' }}" readonly>
          </td>
          <td>
            <input type="number" step="0.01" min="0" max="100" class="form-control" id="avg-{{ en.student.id }}" name="avg_{{ en.student.id }}" value="{% if en.average is not None %}{{ en.average }}{% else %}{% endif %}" disabled>
          </td>
          <td>
            <div class="btn-group" role="group" aria-label="Edit fields">
              <button type="button" class="btn btn-sm btn-outline-secondary edit-field" data-student-id="{{ en.student.id }}" data-field="quiz">Quiz</button>
              <button type="button" class="btn btn-sm btn-outline-secondary edit-field" data-student-id="{{ en.student.id }}" data-field="mid">Mid</button>
              <button type="button" class="btn btn-sm btn-outline-secondary edit-field" data-student-id="{{ en.student.id }}" data-field="assign">Assign</button>
              <button type="button" class="btn btn-sm btn-outline-secondary edit-field" data-student-id="{{ en.student.id }}" data-field="final">Final</button>
            </div>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-primary save-row" data-student-id="{{ en.student.id }}" data-subject-id="{{ selected_subject.id }}">Save</button>
            <div class="small text-success mt-1" id="status-{{ en.student.id }}" style="display:none;"></div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary" type="submit">Save Scores</button>
  </form>
  <script>
    // get CSRF token from cookie
    function getCookie(name) {
      let v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
    // live total computation when component inputs change
    document.querySelectorAll('.comp-input').forEach(function(inp){
      inp.addEventListener('input', function(){
        const id = this.id.split('-')[1];
        const q = parseFloat(document.getElementById('quiz-'+id).value) || 0;
        const m = parseFloat(document.getElementById('mid-'+id).value) || 0;
        const a = parseFloat(document.getElementById('assign-'+id).value) || 0;
        const f = parseFloat(document.getElementById('final-'+id).value) || 0;
        const total = Math.min(100, Math.max(0, q + m + a + f));
        const totalEl = document.getElementById('total-'+id);
        if (totalEl) totalEl.value = total;
      });
    });
    // per-assessment Edit buttons: toggle edit state for a specific component
    document.querySelectorAll('.edit-field').forEach(function(btn){
      btn.addEventListener('click', function(){
        const sid = this.dataset.studentId;
        const field = this.dataset.field; // quiz, mid, assign, final
        const inputId = field + '-' + sid;
        const inputEl = document.getElementById(inputId);
        if (!inputEl) return;
        const isDisabled = inputEl.disabled;
        if (isDisabled) {
          inputEl.disabled = false;
          inputEl.classList.add('border-primary');
          this.textContent = 'Lock';
          // enable average for possible override
          const avgEl = document.getElementById('avg-' + sid);
          if (avgEl) { avgEl.disabled = false; avgEl.classList.add('border-primary'); }
        } else {
          inputEl.disabled = true;
          inputEl.classList.remove('border-primary');
          this.textContent = field.charAt(0).toUpperCase() + field.slice(1);
          // if no other fields enabled, disable avg
          const otherFields = ['quiz','mid','assign','final'];
          let anyEnabled = false;
          otherFields.forEach(function(f){
            const e = document.getElementById(f + '-' + sid);
            if (e && !e.disabled) anyEnabled = true;
          });
          const avgEl = document.getElementById('avg-' + sid);
          if (avgEl && !anyEnabled) { avgEl.disabled = true; avgEl.classList.remove('border-primary'); }
        }
      });
    });

    // per-row Save: send AJAX to server to persist component scores for a student
    document.querySelectorAll('.save-row').forEach(function(btn){
      btn.addEventListener('click', function(){
        const studentId = this.dataset.studentId;
        const subjectId = this.dataset.subjectId;
        const statusEl = document.getElementById('status-' + studentId);

        const quizEl = document.getElementById('quiz-' + studentId);
        const midEl = document.getElementById('mid-' + studentId);
        const assignEl = document.getElementById('assign-' + studentId);
        const finalEl = document.getElementById('final-' + studentId);
        const totalEl = document.getElementById('total-' + studentId);
        const avgEl = document.getElementById('avg-' + studentId);

        const formData = new FormData();
        formData.append('student_id', studentId);
        formData.append('subject_id', subjectId);
        formData.append('quiz', quizEl ? quizEl.value : '');
        formData.append('mid', midEl ? midEl.value : '');
        formData.append('assignment', assignEl ? assignEl.value : '');
        formData.append('final_exam', finalEl ? finalEl.value : '');
        formData.append('score', totalEl ? totalEl.value : '');
        // include overridden average only if enabled
        if (avgEl && !avgEl.disabled) formData.append('override_avg', avgEl.value);

        statusEl.style.display = 'block';
        statusEl.classList.remove('text-danger','text-success');
        statusEl.textContent = 'Saving...';

        fetch('{% url "save_student_score" %}', {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: formData
        }).then(r => r.json()).then(data => {
          if (data.success) {
            statusEl.classList.remove('text-danger');
            statusEl.classList.add('text-success');
            statusEl.textContent = 'Saved';
            // update displayed totals/averages if returned
            if (data.total !== undefined) {
              const t = document.getElementById('total-' + studentId);
              if (t) t.value = data.total;
            }
            if (data.avg !== undefined) {
              const a = document.getElementById('avg-' + studentId);
              if (a) a.value = data.avg;
            }
            // after save, disable edited inputs and reset edit buttons for this row
            ['quiz','mid','assign','final'].forEach(function(f){
              const e = document.getElementById(f + '-' + studentId);
              if (e) { e.disabled = true; e.classList.remove('border-primary'); }
              const b = document.querySelector('.edit-field[data-student-id="' + studentId + '"][data-field="' + f + '"]');
              if (b) b.textContent = f.charAt(0).toUpperCase() + f.slice(1);
            });
            if (avgEl) { avgEl.disabled = true; avgEl.classList.remove('border-primary'); }
          } else {
            statusEl.classList.remove('text-success');
            statusEl.classList.add('text-danger');
            statusEl.textContent = data.message || 'Error';
          }
        }).catch(err => {
          statusEl.classList.remove('text-success');
          statusEl.classList.add('text-danger');
          statusEl.textContent = 'Network error';
        });
      });
    });
  </script>
  {% else %}
    <p>Please select a subject to enter scores.</p>
  {% endif %}
</div>
{% endblock %}
